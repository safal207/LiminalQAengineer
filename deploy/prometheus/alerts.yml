# Alert rules for LiminalQA monitoring
groups:
  - name: liminalqa_alerts
    interval: 30s
    rules:
      # Алерт: сервис недоступен
      - alert: ServiceDown
        expr: up{job=~"liminalqa.*"} == 0
        for: 1m
        labels:
          severity: critical
          component: '{{ $labels.service }}'
        annotations:
          summary: "Service {{ $labels.service }} is down"
          description: "{{ $labels.service }} has been down for more than 1 minute"

      # Алерт: высокий процент ошибок
      - alert: HighErrorRate
        expr: |
          (
            rate(liminalqa_test_failures_total[5m])
            /
            rate(liminalqa_tests_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High test failure rate detected"
          description: "Test failure rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      # Алерт: медленное выполнение тестов
      - alert: SlowTestExecution
        expr: |
          histogram_quantile(0.95,
            rate(liminalqa_test_duration_seconds_bucket[5m])
          ) > 30
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Tests are executing slowly"
          description: "95th percentile test execution time is {{ $value }}s"

      # Алерт: высокое использование памяти
      - alert: HighMemoryUsage
        expr: |
          (
            process_resident_memory_bytes{job=~"liminalqa.*"}
            /
            1024 / 1024
          ) > 1024
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage on {{ $labels.service }}"
          description: "Memory usage is {{ $value }}MB"

      # Алерт: нет активности
      - alert: NoTestActivity
        expr: |
          rate(liminalqa_tests_total[10m]) == 0
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "No test activity detected"
          description: "No tests have been executed in the last 15 minutes"
