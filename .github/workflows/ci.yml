name: üõ°Ô∏è CI Guardian

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: "-D warnings"

jobs:
  # ============================================================================
  # Job 1: Fast Tests (< 2 min)
  # ============================================================================
  fast-tests:
    name: ‚ö° Fast Tests
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: üß™ Run unit tests
        run: cargo test --lib --workspace --verbose

      - name: üìä Test report
        if: always()
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Unit tests completed!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 2: Integration Tests (< 3 min)
  # ============================================================================
  integration-tests:
    name: üîó Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache
        uses: Swatinem/rust-cache@v2

      - name: üß™ Run integration tests
        run: cargo test --test '*' --workspace --verbose

  # ============================================================================
  # Job 3: Clippy ‚Äî The Code Whisperer üìé
  # ============================================================================
  clippy:
    name: üìé Clippy
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: üíæ Cache
        uses: Swatinem/rust-cache@v2

      - name: üìé Run Clippy
        run: |
          cargo clippy --all-targets --all-features --workspace -- -D warnings \
            -W clippy::all \
            -W clippy::unwrap_used \
            -W clippy::expect_used

      - name: üìä Clippy report
        if: always()
        run: |
          echo "## üìé Clippy Results" >> $GITHUB_STEP_SUMMARY
          echo "No warnings found! üéâ" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 4: Format ‚Äî Keep it Pretty üíÖ
  # ============================================================================
  format:
    name: üíÖ Format Check
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: üíÖ Check formatting
        run: cargo fmt --all -- --check

  # ============================================================================
  # Job 5: Security Audit üîí
  # ============================================================================
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîí Run cargo-audit
        uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Job 6: Code Coverage üìä
  # ============================================================================
  coverage:
    name: üìä Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üìä Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: üìä Generate coverage
        run: |
          cargo tarpaulin --workspace --out Xml --output-dir ./coverage

      - name: üì§ Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/cobertura.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: üìä Coverage report
        run: |
          echo "## üìä Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "Coverage uploaded to Codecov!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 7: Build All Targets üèóÔ∏è
  # ============================================================================
  build:
    name: üèóÔ∏è Build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: üíæ Cache
        uses: Swatinem/rust-cache@v2

      - name: üèóÔ∏è Build workspace
        run: cargo build --workspace --verbose --all-features

      - name: üìä Build report
        run: |
          echo "## üèóÔ∏è Build Success on ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 8: Benchmarks (on main only) ‚ö°
  # ============================================================================
  benchmarks:
    name: ‚ö° Performance Benchmarks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache
        uses: Swatinem/rust-cache@v2

      - name: ‚ö° Run benchmarks
        run: cargo bench --workspace --no-fail-fast

      - name: üìä Benchmark results
        run: |
          echo "## ‚ö° Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "Benchmarks completed!" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Job 9: Doc Tests üìö
  # ============================================================================
  doc-tests:
    name: üìö Documentation Tests
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: üíæ Cache
        uses: Swatinem/rust-cache@v2

      - name: üìö Test documentation
        run: cargo test --doc --workspace

      - name: üìñ Build docs
        run: cargo doc --no-deps --workspace --all-features

  # ============================================================================
  # Final: All Green! üéâ
  # ============================================================================
  all-checks:
    name: ‚úÖ All Checks Passed
    runs-on: ubuntu-latest
    needs:
      - fast-tests
      - integration-tests
      - clippy
      - format
      - security
      - coverage
      - build
      - doc-tests
    steps:
      - name: üéâ Success
        run: |
          echo "## üéâ All Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "Your code is beautiful! üíñ" >> $GITHUB_STEP_SUMMARY
